from ninfo import PluginBase
import simplejson
import urllib
import urllib2

class vtotal_plug(PluginBase):
    """This plugin returns any information from VirusTotal"""
    name    =    'vtotal'
    title   =    'VirusTotal'
    description   =  'Looks up only hashes in the VirusTotal database'
    cache_timeout   =  60*60
    types   =    ['hash']
    local = False

    def setup(self):
        c = self.plugin_config
        self.api_key = c['api_key']

    def get_info(self, arg):
        url = 'https://www.virustotal.com/vtapi/v2/file/report'
        parameters = {"resource": arg, "apikey": self.api_key}
        data = urllib.urlencode(parameters)
        req = urllib2.Request(url, data)
        response = urllib2.urlopen(req)
        derp = response.read()
        json = simplejson.loads(derp)
        if json['response_code'] == 1:
            return json
        else:
            return 0

plugin_class = vtotal_plug

# Here's what things look like on a sample query:

# >>> print json
# {"scans": {"Bkav": {"detected": false, "version": "1.3.0.7133", "result": null, "update": "20150908"}, "MicroWorld-eScan": {"detected": true, "version": "12.0.250.0", "result": "Generic.Malware.V!w.7232B058", "update": "20150908"}, "nProtect": {"detected": true, "version": "2015-09-08.01", "result": "Trojan/W32.Small.28672.BJA", "update": "20150908"}, "CMC": {"detected": true, "version": "1.1.0.977", "result": "Trojan.Win32.VB!O", "update": "20150908"}, "CAT-QuickHeal": {"detected": true, "version": "14.00", "result": "Trojan.Comame.r3", "update": "20150908"}, "McAfee": {"detected": true, "version": "6.0.6.653", "result": "Artemis!99017F6EEBBA", "update": "20150908"}, "Malwarebytes": {"detected": true, "version": "2.1.1.1115", "result": "Trojan.Qhost", "update": "20150908"}, "Zillya": {"detected": true, "version": "2.0.0.2390", "result": "Trojan.VB.Win32.33493", "update": "20150908"}, "SUPERAntiSpyware": {"detected": false, "version": "5.6.0.1032", "result": null, "update": "20150908"}, "K7AntiVirus": {"detected": true, "version": "9.209.17146", "result": "Trojan ( 000905281 )", "update": "20150908"}, "Alibaba": {"detected": false, "version": "1.0", "result": null, "update": "20150902"}, "K7GW": {"detected": true, "version": "9.209.17145", "result": "Trojan ( 000905281 )", "update": "20150908"}, "TheHacker": {"detected": true, "version": "6.8.0.5.657", "result": "Trojan/VB.acgy", "update": "20150907"}, "Arcabit": {"detected": true, "version": "1.0.0.425", "result": "Generic.Malware.V!w.7232B058", "update": "20150905"}, "NANO-Antivirus": {"detected": true, "version": "0.30.24.3283", "result": "Trojan.Win32.VB.wjvtg", "update": "20150908"}, "Cyren": {"detected": true, "version": "5.4.16.7", "result": "W32/Risk.PCSE-1644", "update": "20150908"}, "Symantec": {"detected": true, "version": "20141.2.0.56", "result": "Trojan.KillAV", "update": "20150907"}, "ESET-NOD32": {"detected": true, "version": "12220", "result": "a variant of Win32/Qhost.NTY", "update": "20150908"}, "TrendMicro-HouseCall": {"detected": true, "version": "9.800.0.1009", "result": "TROJ_VB.JVJ", "update": "20150908"}, "Avast": {"detected": true, "version": "8.0.1489.320", "result": "Win32:VB-ZOF [Spy]", "update": "20150908"}, "ClamAV": {"detected": false, "version": "0.98.5.0", "result": null, "update": "20150908"}, "Kaspersky": {"detected": true, "version": "15.0.1.10", "result": "Trojan.Win32.Hosts2.gen", "update": "20150908"}, "BitDefender": {"detected": true, "version": "7.2", "result": "Generic.Malware.V!w.7232B058", "update": "20150908"}, "Agnitum": {"detected": true, "version": "5.5.1.3", "result": "Trojan.VB!vKk0A3BnXnA", "update": "20150907"}, "ViRobot": {"detected": true, "version": "2014.3.20.0", "result": "Trojan.Win32.VB.28672.CK[h]", "update": "20150908"}, "ByteHero": {"detected": false, "version": "1.0.0.1", "result": null, "update": "20150908"}, "Tencent": {"detected": true, "version": "1.0.0.1", "result": "Win32.Trojan.Vb.Hryf", "update": "20150908"}, "Ad-Aware": {"detected": true, "version": "12.0.163.0", "result": "Generic.Malware.V!w.7232B058", "update": "20150908"}, "Emsisoft": {"detected": true, "version": "3.5.0.642", "result": "Generic.Malware.V!w.7232B058 (B)", "update": "20150908"}, "Comodo": {"detected": true, "version": "23197", "result": "Heur.Suspicious", "update": "20150908"}, "F-Secure": {"detected": true, "version": "11.0.19100.45", "result": "Generic.Malware.V!w.7232B058", "update": "20150908"}, "DrWeb": {"detected": true, "version": "7.0.15.8310", "result": "Trojan.Hosts.37", "update": "20150908"}, "VIPRE": {"detected": true, "version": "43578", "result": "Trojan.Win32.Generic!BT", "update": "20150908"}, "TrendMicro": {"detected": true, "version": "9.740.0.1012", "result": "TROJ_VB.JVJ", "update": "20150908"}, "McAfee-GW-Edition": {"detected": true, "version": "v2015", "result": "BehavesLike.Win32.Trojan.mz", "update": "20150907"}, "Sophos": {"detected": true, "version": "4.98.0", "result": "Troj/VBHost-A", "update": "20150908"}, "F-Prot": {"detected": true, "version": "4.7.1.166", "result": "W32/MalwareS.NQG", "update": "20150908"}, "Jiangmin": {"detected": true, "version": "16.0.100", "result": "Trojan/VB.cqak", "update": "20150907"}, "Avira": {"detected": true, "version": "8.3.2.2", "result": "TR/VB.dyn", "update": "20150908"}, "Antiy-AVL": {"detected": true, "version": "1.0.0.1", "result": "Trojan/Win32.Hosts2", "update": "20150908"}, "Kingsoft": {"detected": true, "version": "2013.4.9.267", "result": "Win32.Troj.VB.(kcloud)", "update": "20150908"}, "Microsoft": {"detected": true, "version": "1.1.12002.0", "result": "Trojan:Win32/Comame!gmb", "update": "20150908"}, "AegisLab": {"detected": false, "version": "1.5", "result": null, "update": "20150908"}, "AhnLab-V3": {"detected": true, "version": "2015.09.09.00", "result": "Win-Trojan/Xema.variant", "update": "20150908"}, "GData": {"detected": true, "version": "25", "result": "Generic.Malware.V!w.7232B058", "update": "20150908"}, "TotalDefense": {"detected": true, "version": "37.1.62.1", "result": "Win32/ASuspect.HDBBD", "update": "20150908"}, "ALYac": {"detected": true, "version": "1.0.1.4", "result": "Generic.Malware.V!w.7232B058", "update": "20150908"}, "AVware": {"detected": true, "version": "1.5.0.21", "result": "Trojan.Win32.Generic!BT", "update": "20150901"}, "VBA32": {"detected": true, "version": "3.12.26.4", "result": "SScope.Trojan.VBRA.15773", "update": "20150907"}, "Baidu-International": {"detected": true, "version": "3.5.1.41473", "result": "Trojan.Win32.Hosts2.gen", "update": "20150908"}, "Zoner": {"detected": false, "version": "1.0", "result": null, "update": "20150908"}, "Rising": {"detected": true, "version": "25.0.0.17", "result": "PE:Trojan.Win32.Generic.123D3CB0!306003120[F1]", "update": "20150906"}, "Ikarus": {"detected": true, "version": "T3.1.9.5.0", "result": "Trojan.Win32.Qhost", "update": "20150908"}, "Fortinet": {"detected": true, "version": "5.1.220.0", "result": "W32/Vb.HT!tr", "update": "20150908"}, "AVG": {"detected": true, "version": "16.0.0.4409", "result": "VBCrypt.AWJ", "update": "20150908"}, "Panda": {"detected": true, "version": "4.6.4.2", "result": "Adware/AccesMembre", "update": "20150908"}, "Qihoo-360": {"detected": true, "version": "1.0.0.1015", "result": "Win32/Trojan.Spy.fd9", "update": "20150908"}}, "scan_id": "52d3df0ed60c46f336c131bf2ca454f73bafdc4b04dfa2aea80746f5ba9e6d1c-1441715045", "sha1": "4d1740485713a2ab3a4f5822a01f645fe8387f92", "resource": "99017f6eebbac24f351415dd410d522d", "response_code": 1, "scan_date": "2015-09-08 12:24:05", "permalink": "https://www.virustotal.com/file/52d3df0ed60c46f336c131bf2ca454f73bafdc4b04dfa2aea80746f5ba9e6d1c/analysis/1441715045/", "verbose_msg": "Scan finished, information embedded", "total": 57, "positives": 50, "sha256": "52d3df0ed60c46f336c131bf2ca454f73bafdc4b04dfa2aea80746f5ba9e6d1c", "md5": "99017f6eebbac24f351415dd410d522d"}

# >>> derp = simplejson.loads(json)
# >>> derp
# {'scan_id': '52d3df0ed60c46f336c131bf2ca454f73bafdc4b04dfa2aea80746f5ba9e6d1c-1441715045', 'sha1': '4d1740485713a2ab3a4f5822a01f645fe8387f92', 'resource': '99017f6eebbac24f351415dd410d522d', 'response_code': 1, 'scan_date': '2015-09-08 12:24:05', 'permalink': 'https://www.virustotal.com/file/52d3df0ed60c46f336c131bf2ca454f73bafdc4b04dfa2aea80746f5ba9e6d1c/analysis/1441715045/', 'verbose_msg': 'Scan finished, information embedded', 'sha256': '52d3df0ed60c46f336c131bf2ca454f73bafdc4b04dfa2aea80746f5ba9e6d1c', 'positives': 50, 'total': 57, 'md5': '99017f6eebbac24f351415dd410d522d', 'scans': {'Bkav': {'detected': False, 'version': '1.3.0.7133', 'result': None, 'update': '20150908'}, 'TotalDefense': {'detected': True, 'version': '37.1.62.1', 'result': 'Win32/ASuspect.HDBBD', 'update': '20150908'}, 'MicroWorld-eScan': {'detected': True, 'version': '12.0.250.0', 'result': 'Generic.Malware.V!w.7232B058', 'update': '20150908'}, 'nProtect': {'detected': True, 'version': '2015-09-08.01', 'result': 'Trojan/W32.Small.28672.BJA', 'update': '20150908'}, 'CMC': {'detected': True, 'version': '1.1.0.977', 'result': 'Trojan.Win32.VB!O', 'update': '20150908'}, 'CAT-QuickHeal': {'detected': True, 'version': '14.00', 'result': 'Trojan.Comame.r3', 'update': '20150908'}, 'McAfee': {'detected': True, 'version': '6.0.6.653', 'result': 'Artemis!99017F6EEBBA', 'update': '20150908'}, 'Malwarebytes': {'detected': True, 'version': '2.1.1.1115', 'result': 'Trojan.Qhost', 'update': '20150908'}, 'VIPRE': {'detected': True, 'version': '43578', 'result': 'Trojan.Win32.Generic!BT', 'update': '20150908'}, 'AegisLab': {'detected': False, 'version': '1.5', 'result': None, 'update': '20150908'}, 'K7AntiVirus': {'detected': True, 'version': '9.209.17146', 'result': 'Trojan ( 000905281 )', 'update': '20150908'}, 'BitDefender': {'detected': True, 'version': '7.2', 'result': 'Generic.Malware.V!w.7232B058', 'update': '20150908'}, 'K7GW': {'detected': True, 'version': '9.209.17145', 'result': 'Trojan ( 000905281 )', 'update': '20150908'}, 'TheHacker': {'detected': True, 'version': '6.8.0.5.657', 'result': 'Trojan/VB.acgy', 'update': '20150907'}, 'Agnitum': {'detected': True, 'version': '5.5.1.3', 'result': 'Trojan.VB!vKk0A3BnXnA', 'update': '20150907'}, 'Cyren': {'detected': True, 'version': '5.4.16.7', 'result': 'W32/Risk.PCSE-1644', 'update': '20150908'}, 'Symantec': {'detected': True, 'version': '20141.2.0.56', 'result': 'Trojan.KillAV', 'update': '20150907'}, 'ESET-NOD32': {'detected': True, 'version': '12220', 'result': 'a variant of Win32/Qhost.NTY', 'update': '20150908'}, 'TrendMicro-HouseCall': {'detected': True, 'version': '9.800.0.1009', 'result': 'TROJ_VB.JVJ', 'update': '20150908'}, 'Avast': {'detected': True, 'version': '8.0.1489.320', 'result': 'Win32:VB-ZOF [Spy]', 'update': '20150908'}, 'ClamAV': {'detected': False, 'version': '0.98.5.0', 'result': None, 'update': '20150908'}, 'Kaspersky': {'detected': True, 'version': '15.0.1.10', 'result': 'Trojan.Win32.Hosts2.gen', 'update': '20150908'}, 'Alibaba': {'detected': False, 'version': '1.0', 'result': None, 'update': '20150902'}, 'NANO-Antivirus': {'detected': True, 'version': '0.30.24.3283', 'result': 'Trojan.Win32.VB.wjvtg', 'update': '20150908'}, 'ViRobot': {'detected': True, 'version': '2014.3.20.0', 'result': 'Trojan.Win32.VB.28672.CK[h]', 'update': '20150908'}, 'Rising': {'detected': True, 'version': '25.0.0.17', 'result': 'PE:Trojan.Win32.Generic.123D3CB0!306003120[F1]', 'update': '20150906'}, 'Ad-Aware': {'detected': True, 'version': '12.0.163.0', 'result': 'Generic.Malware.V!w.7232B058', 'update': '20150908'}, 'Sophos': {'detected': True, 'version': '4.98.0', 'result': 'Troj/VBHost-A', 'update': '20150908'}, 'Comodo': {'detected': True, 'version': '23197', 'result': 'Heur.Suspicious', 'update': '20150908'}, 'F-Secure': {'detected': True, 'version': '11.0.19100.45', 'result': 'Generic.Malware.V!w.7232B058', 'update': '20150908'}, 'DrWeb': {'detected': True, 'version': '7.0.15.8310', 'result': 'Trojan.Hosts.37', 'update': '20150908'}, 'Zillya': {'detected': True, 'version': '2.0.0.2390', 'result': 'Trojan.VB.Win32.33493', 'update': '20150908'}, 'TrendMicro': {'detected': True, 'version': '9.740.0.1012', 'result': 'TROJ_VB.JVJ', 'update': '20150908'}, 'McAfee-GW-Edition': {'detected': True, 'version': 'v2015', 'result': 'BehavesLike.Win32.Trojan.mz', 'update': '20150907'}, 'Emsisoft': {'detected': True, 'version': '3.5.0.642', 'result': 'Generic.Malware.V!w.7232B058 (B)', 'update': '20150908'}, 'F-Prot': {'detected': True, 'version': '4.7.1.166', 'result': 'W32/MalwareS.NQG', 'update': '20150908'}, 'Jiangmin': {'detected': True, 'version': '16.0.100', 'result': 'Trojan/VB.cqak', 'update': '20150907'}, 'Avira': {'detected': True, 'version': '8.3.2.2', 'result': 'TR/VB.dyn', 'update': '20150908'}, 'Fortinet': {'detected': True, 'version': '5.1.220.0', 'result': 'W32/Vb.HT!tr', 'update': '20150908'}, 'Antiy-AVL': {'detected': True, 'version': '1.0.0.1', 'result': 'Trojan/Win32.Hosts2', 'update': '20150908'}, 'Kingsoft': {'detected': True, 'version': '2013.4.9.267', 'result': 'Win32.Troj.VB.(kcloud)', 'update': '20150908'}, 'Arcabit': {'detected': True, 'version': '1.0.0.425', 'result': 'Generic.Malware.V!w.7232B058', 'update': '20150905'}, 'SUPERAntiSpyware': {'detected': False, 'version': '5.6.0.1032', 'result': None, 'update': '20150908'}, 'AhnLab-V3': {'detected': True, 'version': '2015.09.09.00', 'result': 'Win-Trojan/Xema.variant', 'update': '20150908'}, 'Microsoft': {'detected': True, 'version': '1.1.12002.0', 'result': 'Trojan:Win32/Comame!gmb', 'update': '20150908'}, 'ByteHero': {'detected': False, 'version': '1.0.0.1', 'result': None, 'update': '20150908'}, 'ALYac': {'detected': True, 'version': '1.0.1.4', 'result': 'Generic.Malware.V!w.7232B058', 'update': '20150908'}, 'AVware': {'detected': True, 'version': '1.5.0.21', 'result': 'Trojan.Win32.Generic!BT', 'update': '20150901'}, 'VBA32': {'detected': True, 'version': '3.12.26.4', 'result': 'SScope.Trojan.VBRA.15773', 'update': '20150907'}, 'Panda': {'detected': True, 'version': '4.6.4.2', 'result': 'Adware/AccesMembre', 'update': '20150908'}, 'Zoner': {'detected': False, 'version': '1.0', 'result': None, 'update': '20150908'}, 'Tencent': {'detected': True, 'version': '1.0.0.1', 'result': 'Win32.Trojan.Vb.Hryf', 'update': '20150908'}, 'Ikarus': {'detected': True, 'version': 'T3.1.9.5.0', 'result': 'Trojan.Win32.Qhost', 'update': '20150908'}, 'GData': {'detected': True, 'version': '25', 'result': 'Generic.Malware.V!w.7232B058', 'update': '20150908'}, 'AVG': {'detected': True, 'version': '16.0.0.4409', 'result': 'VBCrypt.AWJ', 'update': '20150908'}, 'Baidu-International': {'detected': True, 'version': '3.5.1.41473', 'result': 'Trojan.Win32.Hosts2.gen', 'update': '20150908'}, 'Qihoo-360': {'detected': True, 'version': '1.0.0.1015', 'result': 'Win32/Trojan.Spy.fd9', 'update': '20150908'}}}
# >>> derp['sha1']
# '4d1740485713a2ab3a4f5822a01f645fe8387f92'
# >>> for key in derp['scans']:
# ...     print key
